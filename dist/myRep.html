<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>我的报告</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	    <meta http-equiv="X-UA-Compatible" content="edge" />
	    <link rel="stylesheet" type="text/css" href="css/mui.min.css"/>
	    <link rel="stylesheet" href="css/icons-extra.css" />	
	    <link rel="stylesheet" href="css/footer.css" />	  
	    <link rel="stylesheet" href="css/myrep.css" />	
	</head>
	<body>
		<!--页面主结构开始-->
		
		<header class="mui-bar mui-bar-nav">   
	    	<img style="height:51px;" src="img/jj.png" alt="" />
	    	<h1 class="mui-row">	    		
				<div class="mui-col-xs-9">
					<app class="mui-pull-left">
						<img src="img/me.jpg" alt="" />
					</app>
					<div class="mui-pull-right">
						<h4>
							<span>伊凡</span>(<span>男</span>)
						</h4>
						<p>TEL : <span>121348946</span></p>
					</div>
				</div>
				<div class="mui-col-xs-3" style="text-align: right;">
					<app href="regist.html" class="mui-btn mui-btn-outlined">个人信息</app>
					<app href="datepage.html" class="mui-btn mui-btn-outlined">健康档案</app>
				</div>							
	    	</h1>
	    	<div class="delive-line"></div>
		</header>
		<!--底部导航-->
		 <nav id="footer" class="mui-bar mui-bar-tab">
	        <app class="mui-tab-checkup" href="index.html">
	            <span class="mui-icon-extra mui-icon-extra-heart-filled"></span>
	            <span class="mui-tab-label">首页</span>
	        </app>
	        <app class="mui-tab-checkup" href="branch.html">
	            <span class="mui-icon-extra mui-icon-extra-class"></span>
	            <span class="mui-tab-label">分院</span>
	        </app>
	        <app class="mui-tab-checkup mui-active">
	            <span class="mui-icon mui-icon-contact"></span>
	            <span class="mui-tab-label">我的</span>
	        </app>
	    </nav>
		<!--正文-->		
		<div class="mui-scroll-wrapper">
			<div class="mui-scroll">
				<!--这里放置真实显示的DOM内容-->
				<div class="mui-content">
			    	<div class="mui-content-padded">
			    		<div id="segmentedControls" class="mui-segmented-control mui-segmented-control-inverted mui-segmented-control-vertical">
			    			<app class="mui-control-checkup my-btnkey mui-active" href="#myreport">我的报告</app>
			    			<app class="mui-control-checkup my-btnkey" href="#mydate">我的预约</app>
			    		</div>
			    		<div id="segmentedControlContents">
			    			<div id="myreport" class="mui-control-content mui-active">
			    				<ul class="mui-table-view">
			    					<!--<li class="mui-table-view-cell mui-media">
			    			app		<a href="javascript:;">
											<img class="mui-media-object mui-pull-left" src="img/rep.png">
											<div class="mui-media-body">
												<div class="mui-pull-left">
													<p>伊凡</p>
													<p class="mui-ellipsis">2017年3月20日</p>
													<p>温州体检中心</p>
												</div>
												<div class="mui-pull-right">
													<p type='button' class="mui-btn mui-btn-outlined">查看报告</p>
												</div>
											</div>
								app	</a>
			    					</li>
			    					<li class="mui-table-view-cell mui-media">
			    			app		<a href="javascript:;">
											<img class="mui-media-object mui-pull-left" src="img/rep.png">
											<div class="mui-media-body">
												<div class="mui-pull-left">
													<p>伊凡</p>
													<p class="mui-ellipsis">2017年3月20日</p>
													<p>温州体检中心</p>
												</div>
												<div class="mui-pull-right">
													<p>未出报告</p>
												</div>
											</div>
								app	</a>
			    					</li>
			    					<li class="mui-table-view-cell mui-media">
			    			app		<a href="javascript:;">
											<img class="mui-media-object mui-pull-left" src="img/rep.png">
											<div class="mui-media-body">
												<div class="mui-pull-left">
													<p>伊凡</p>
													<p class="mui-ellipsis">2017年3月20日</p>
													<p>温州体检中心</p>
												</div>
												<div class="mui-pull-right">
													<p type='button' class="mui-btn mui-btn-outlined">查看报告</p>
												</div>
											</div>
								app	</a>
			    					</li>-->
			    				</ul>
			    			</div>
			    			<div id="mydate" class="mui-control-content">
			    				<ul class="mui-table-view">
			    					<!--<li class="mui-table-view-cell mui-media">
			    						<div class="mui-media-body mui-row">
											<div class="mui-pull-left mui-col-xs-6">
												<p><span>杭州韩诺体检中心</span></p>
												<p>体检日期:<span>2017-3-20</span></p>
												<p>预约日期:<span>2017-3-20</span></p>
											</div>
											<div class="mui-pull-right mui-col-xs-6">
												<p><span>伊凡</span></p>
												<p>
										app		<a href="tel://10086" class="mui-btn mui-btn-success">
														<span class="mui-icon mui-icon-phone"></span>
											app	</a>
													<button class="changedate mui-btn mui-btn-primary">改约</button>
													<button class="deldate mui-btn mui-btn-primary">取消</button>
												</p>
											</div>
										</div>
			    					</li>
			    					<li class="mui-table-view-cell">
			    						<div class="mui-media-body mui-row">
											<div class="mui-pull-left mui-col-xs-6">
												<p><span>杭州韩诺体检中心</span></p>
												<p>体检日期:<span>2017-3-20</span></p>
												<p>预约日期:<span>2017-3-20</span></p>
											</div>
											<div class="mui-pull-right mui-col-xs-6">
												<p><span>伊凡</span></p>
												<p>
										app		<a href="tel://10086" class="mui-btn mui-btn-success">
														<span class="mui-icon mui-icon-phone"></span>
											app	</a>
													<button class="mui-btn mui-btn-warning myjudge">待评价</button>
												</p>
											</div>
										</div>
			    					</li>
			    					<li class="mui-table-view-cell">
			    						<div class="mui-media-body mui-row">
											<div class="mui-pull-left mui-col-xs-6">
												<p><span>杭州韩诺体检中心</span></p>
												<p>体检日期:<span>2017-12-20</span></p>
												<p>预约日期:<span>2017-12-20</span></p>
											</div>
											<div class="mui-pull-right mui-col-xs-6">
												<p><span>伊凡</span></p>
												<p>
										app		<a href="tel://10086" class="mui-btn mui-btn-success">
														<span class="mui-icon mui-icon-phone"></span>
											app	</a>
													<span class="mydel">已取消</span>
												</p>
											</div>
										</div>
			    					</li>
			    					<li class="mui-table-view-cell">
			    						<div class="mui-media-body mui-row">
											<div class="mui-pull-left mui-col-xs-6">
												<p><span>杭州韩诺体检中心</span></p>
												<p>体检日期:<span>2017-12-20</span></p>
												<p>预约日期:<span>2017-12-20</span></p>
											</div>
											<div class="mui-pull-right mui-col-xs-6">
												<p><span>伊凡</span></p>
												<p>
										app		<a href="tel://10086" class="mui-btn mui-btn-success">
														<span class="mui-icon mui-icon-phone"></span>
											app	</a>
													<span class="myfinish">已评价</span>
												</p>
											</div>
										</div>
			    					</li>-->
			    					<!--<li class="mui-table-view-cell">-->
			    						<!--<div class="mui-media-body mui-row">
											<div class="mui-pull-left mui-col-xs-6">
												<p><span>杭州韩诺体检中心</span></p>
												<p>预约日期:<span>2017-12-20</span></p>
												<p>当天日期:<span>2017-12-20</span></p>
											</div>
											<div class="mui-pull-right mui-col-xs-6">
												<p><span>伊凡</span></p>
												<p>
										app		<a href="tel://10086" class="mui-btn mui-btn-success">
														<span class="mui-icon mui-icon-phone"></span>
											app	</a>
													<span class="mying">体检中</span>
												</p>
											</div>
										</div>
			    					</li>-->
			    				</ul>
			    			</div>
			    		</div>
			    	</div>
				</div>   
			</div>
	</div>

		<!--页面主结构结束-->
		<script src="js/jquery-2.1.4.min.js"></script>
		<script src="js/mui.min.js"></script>		
	    <script type="text/javascript" src="js/bear-token.js"></script>		
		<script type="text/javascript">
		var DEPART=0;
            mui.init({
              swipeBack:false,
            });
            mui('.mui-scroll-wrapper').scroll({
			 scrollY: true, //是否竖向滚动
			 scrollX: false, //是否横向滚动
			 startX: 0, //初始化时滚动至x
			 startY: 0, //初始化时滚动至y
			 indicators: true, //是否显示滚动条
			 deceleration:0.0006, //阻尼系数,系数越小滑动越灵敏
			 bounce: true //是否启用回弹
    	});
            
			
			
			$(function(){
				//页面数据加载			
				access();
				var mobile;
				//个人信息
				
				$.getJSON("http://www.elepick.com/api/user",{},function(data){
					if (typeof data === 'string') {
						    data = JSON.parse(data);
					}
					if(data==null){
						
					}else{
						$("header h1 app.mui-pull-left>img").attr("src",data.WC_Info.headimgurl);
						$("header h1 .mui-pull-right>h4").html("<span>"+data.WC_Info.nickname+"</span>\(<span>"+data.sex+"</span>\)");
						$("header h1 .mui-pull-right>p>span").html(data.mobile);
						mobile=data.mobile;
					}
				});
				
				
				//我的报告解析函数
				
					
				
//				$.getJSON('js/myRep.json',{},function(data){
				$.getJSON('http://www.elepick.com/api/appointments',{},function(data){
					if (typeof data === 'string') {
						    data = JSON.parse(data);
					}
					if(data==null){
						
					}else{
						var len=data.length;
						console.log(len);
						var listreport="";
						var listRange="";
						for(var g=0;g<len;g++){
							switch(data[g].status){
								case "预约成功":listRange+='<li class="mui-table-view-cell mui-media"><div class="mui-media-body mui-row"><div class="mui-pull-left mui-col-xs-6"><p><span>'+data[g].org_name+'</span></p><p>体检日期:<span>'+data[g].operatetime+'</span></p><p>预约日期:<span>'+data[g].appointdate+'</span></p></div><div class="mui-pull-right mui-col-xs-6"><p><span>'+data[g].name+'</span></p><p><button href="'+data[g].serve_mobile+'" class="tel mui-btn mui-btn-success"><span class="mui-icon mui-icon-phone"></span></button><button class="changedate mui-btn mui-btn-primary" data-id="'+data[g].appid+'">改约</button><button class="deldate mui-btn mui-btn-primary" data-id="'+data[g].appid+'">取消</button></p></div></div></li>';
									break;
								case '待评价':listRange+='<li class="mui-table-view-cell mui-media"><div class="mui-media-body mui-row"><div class="mui-pull-left mui-col-xs-6"><p><span>'+data[g].org_name+'</span></p><p>体检日期:<span>'+data[g].operatetime+'</span></p><p>预约日期:<span>'+data[g].appointdate+'</span></p></div><div class="mui-pull-right mui-col-xs-6"><p><span>'+data[g].name+'</span></p><p><button href="'+data.serve_mobile+'" class="tel mui-btn mui-btn-success"><span class="mui-icon mui-icon-phone"></span></button><button data-id="'+data[g].appid+'" class="mui-btn mui-btn-warning myjudge">待评价</button></p></div></div></li>';
					
					if(!(data[g].reportid=="")){
						listreport+='<li class="mui-table-view-cell mui-media"><app href="javascript:;"><img class="mui-media-object mui-pull-left" src="img/rep.png"><div class="mui-media-body"><div class="mui-pull-left"><p>'+data[g].name+'</p><p class="mui-ellipsis">'+data[g].appointdate+'</p><p>'+data[g].org_name+'</p></div><div class="mui-pull-right"><p href="'+data[g].appid+'" type="button" class="mui-btn mui-btn-outlined">查看报告</p></div></div></app></li>';
					}else{
						listreport+='<li class="mui-table-view-cell mui-media"><app href="javascript:;"><img class="mui-media-object mui-pull-left" src="img/rep.png"><div class="mui-media-body"><div class="mui-pull-left"><p>'+data[g].name+'</p><p class="mui-ellipsis">'+data[g].appointdate+'</p><p>'+data[g].org_name+'</p></div><div class="mui-pull-right"><p>未出报告</p></div></div></app></li>';
					}
									break;
								case '已取消':listRange+='<li class="mui-table-view-cell mui-media"><div class="mui-media-body mui-row"><div class="mui-pull-left mui-col-xs-6"><p><span>'+data[g].org_name+'</span></p><p>体检日期:<span>'+data[g].operatetime+'</span></p><p>预约日期:<span>'+data[g].appointdate+'</span></p></div><div class="mui-pull-right mui-col-xs-6"><p><span>'+data[g].name+'</span></p><p><button href="'+data[g].serve_mobile+'" class="tel mui-btn mui-btn-success"><span class="mui-icon mui-icon-phone"></span></button><span class="mydel">已取消</span></p></div></div></li>';
									break;
								case '已评价':listRange+='<li class="mui-table-view-cell mui-media"><div class="mui-media-body mui-row"><div class="mui-pull-left mui-col-xs-6"><p><span>'+data[g].org_name+'</span></p><p>体检日期:<span>'+data[g].operatetime+'</span></p><p>预约日期:<span>'+data[g].appointdate+'</span></p></div><div class="mui-pull-right mui-col-xs-6"><p><span>'+data[g].name+'</span></p><p><button href="'+data[g].serve_mobile+'" class="tel mui-btn mui-btn-success"><span class="mui-icon mui-icon-phone"></span></button><span class="myfinish">已评价</span></p></div></div></li>';
								if(!(data[g].reportid=="")){
						listreport+='<li class="mui-table-view-cell mui-media"><app href="javascript:;"><img class="mui-media-object mui-pull-left" src="img/rep.png"><div class="mui-media-body"><div class="mui-pull-left"><p>'+data[g].name+'</p><p class="mui-ellipsis">'+data[g].appointdate+'</p><p>'+data[g].org_name+'</p></div><div class="mui-pull-right"><p href="'+data[g].appid+'" type="button" class="mui-btn mui-btn-outlined">查看报告</p></div></div></app></li>';
					}else{
						listreport+='<li class="mui-table-view-cell mui-media"><app href="javascript:;"><img class="mui-media-object mui-pull-left" src="img/rep.png"><div class="mui-media-body"><div class="mui-pull-left"><p>'+data[g].name+'</p><p class="mui-ellipsis">'+data[g].appointdate+'</p><p>'+data[g].org_name+'</p></div><div class="mui-pull-right"><p>未出报告</p></div></div></app></li>';
					}
									break;
								case '体检中':listRange+='<li class="mui-table-view-cell mui-media"><div class="mui-media-body mui-row"><div class="mui-pull-left mui-col-xs-6"><p><span>'+data[g].org_name+'</span></p><p>体检日期:<span>'+data[g].operatetime+'</span></p><p>预约日期:<span>'+data[g].appointdate+'</span></p></div><div class="mui-pull-right mui-col-xs-6"><p><span>'+data[g].name+'</span></p><p><button href="'+data[g].serve_mobile+'" class="tel mui-btn mui-btn-success"><span class="mui-icon mui-icon-phone"></span></button><span class="mying">体检中</span></p></div></div></li>';
									break;
							}
						};
					$("#mydate>ul.mui-table-view").html(listRange);
					$("#myreport>ul.mui-table-view").html(listreport);
					}
				});
				var snum=60;
				var time1=null;
				
				var appids="";
				//查看报告点击出现弹框
				$("#myreport>ul").on('tap','li .mui-pull-right>.mui-btn',function(e){
					clearInterval(time1);
//					e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
					var btnArray = ['确定', '取消'];					
					mui.prompt('短信已发送至<span>150</span>****<span>6695</span>', '', '请输入短信验证码', btnArray, null,'div');
					$(".mui-popup-input").html('<input id="checknum" type="text" autofocus="" placeholder=""><button id="sendnum"  type="button" class="mui-btn mui-disabled">发送验证码</button>');
					$(".mui-popup-text").css("visibility",'hidden');
					$(".mui-popup-buttons").hide();
					$(".mui-popup-input>button").removeAttr("disabled").removeClass('mui-disabled');
					appids=$(e.target).attr("href");
				});
				//发送验证码点击按钮事件
				
				$("body").on('tap','#sendnum',function(e){
					if($(this).attr('disabled')=="disabled"){
						return false;
					}else{
						
						$.ajax({
							url:"http://www.elepick.com/api/report/"+mobile,
							type:"post",
							data:{},
							success:function(data, textStatus, xhr){
								if(xhr.status=='200'){
									clearInterval(time1);
									snum=60;
									//发送成功，倒计时
									$(".mui-popup-text").css("visibility",'visible');
									time1=setInterval(function(){
										$(".mui-popup-input>button").attr("disabled",'true');
										snum--;
										$(".mui-popup-input>button").html(snum+"s后重发");
										if(snum<=0){
											snum=0;
											$(".mui-popup-text").css("visibility",'hidden');
											$(".mui-popup-input>button").removeAttr("disabled").removeClass('mui-disabled').html("重新发送");
											return clearInterval(time1);
										}
									},1000);
								}
							}
						})
						
						//发送验证码功能实现
						
						
					}
					
				});
				//验证码输入匹配函数
				var checkBool=true;
				$("body").on('input','#checknum',function(){
					//验证码匹配
					if((snum>0)&&(snum<60)){
						if(($(this).val().length>=4)&&(checkBool)){
							checkBool=false;
							var url="http://www.elepick.com/api/appoint/report/"+$(this).val().substr(0,4)+"/"+appids;
							$.getJSON(url,{},function(data, textStatus, xhr){
								checkBool=true;
								if(xhr.status=="200"){
									console.log(data);
									clearInterval(time1);
									snum=60;
									mui.toast("加载检查报告中");
//									window.location.href='report.html';
								}else{
									
								}
							});	
						}
					}
					
				});
				$("div.mui-popup-backdrop.mui-active").on('tap',function(e){
					clearInterval(time1);
					mui.closePopups();
				});
				//取消预约,改约，联系客服,评价
				$("#mydate>ul").on('tap','li.mui-media button',function(e){
					console.log(e.target)
					e.stopPropagation();
					if($(e.target).hasClass("deldate")){
						//取消预约
						var appid=$(e.target).data('id');
						mui.confirm('确认取消该次预约吗？', '', ['是','否'], function(e) {
							if (e.index == 0) {
								//拨打电话
								$.ajax({
									type:"post",
									url:"http://www.elepick.com/api/appointment/"+appid+"/cancel",
									data:JSON.stringify({
										"appointid":appid
									}),
									success:function(data, textStatus, xhr){											
										if(xhr.status=="200"){
											mui.toast('预约已取消');
										}else{
											mui.alert(textStatus+"-"+xhr.status);
										}
										
									},
									error:function(xhr, textStatus){
										console.log(xhr);
	                                    mui.alert(textStatus);
									}
								});
								
							} else {
								//什么也不做，返回页面
								
							}
						});
					}else if($(e.target).hasClass("changedate")){
						//改约
						var appid=$(e.target).data('id');						
						localStorage.appointid=appid;	
						mui.later(function(){
							window.location.href='package.html';
						},100);					
					}else if($(e.target).hasClass("myjudge")){
						//预约评价
						var appids=$(e.target).data('id');						
						localStorage.appointid=appids;
						mui.later(function(){
							window.location.href='judge.html';
						},100);
						
						
					}else if($(e.target).parent('button').hasClass("tel")){
						//联系客服
						var tel=$(e.target).parent('button').attr("href");
						var btnArray = ['<app style="display:inline-block;width:100%;height:100%;" href="tel://'+tel+'">呼叫</app>','取消'];
						mui.confirm(tel, '联系电话:', btnArray, function(e) {
						if (e.index == 0) {
							//拨打电话
	//						alert("我打电话了")
						} else {
							//什么也不做，返回页面
						}
					});
					}


				});
				var iftap=true;//重复提交判断
				mui('body').on('tap','app',function(e){
					if($(this).is("app[href^='tel://']")){
						//拨打电话
						location.href=this.href;
					}else if(($(this).parent('nav').html()==$("#footer").html())||($(this).parents("header").html()==$("header").html())){
						window.location.href=this.href;
					}else{
						
					}
				});
				
			});
			
         
         	
		</script>
	</body>

</html>